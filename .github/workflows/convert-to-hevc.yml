name: Convert WebM to HEVC with Alpha

on:
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - 'public/videos/*.webm'

jobs:
  convert:
    runs-on: macos-latest  # Free macOS runner (2000 minutes/month free for public repos)
    permissions:
      contents: write  # Required to commit files back
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup FFmpeg
        run: |
          echo "Installing FFmpeg..."
          brew install ffmpeg
          ffmpeg -version
      
      - name: Create output directory
        run: |
          mkdir -p public/videos/hevc
          echo "Output directory created"
      
      - name: Convert videos to HEVC with alpha
        run: |
          cd public/videos
          
          echo "Starting video conversion..."
          echo "Videos to convert:"
          ls -lh *.webm 2>/dev/null || echo "No WebM files found"
          
          # Convert each video
          videos=("jalen-edusei-black.webm" "jalen-edusei-white.webm" "jalen-edusei-transition-1.webm" "jalen-edusei-transition-2.webm")
          converted=0
          failed=0
          
          for video in "${videos[@]}"; do
            if [ -f "$video" ]; then
              output="${video%.webm}.mov"
              echo ""
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo "Converting: $video → hevc/$output"
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              
              if ffmpeg -c:v libvpx-vp9 -i "$video" \
                -c:v hevc_videotoolbox \
                -allow_sw 1 \
                -alpha_quality 0.75 \
                -vtag hvc1 \
                -vf "premultiply=inplace=1" \
                -q:v 35 \
                -an \
                -y \
                "hevc/$output" 2>&1 | tee /tmp/ffmpeg.log; then
                echo "✓ Successfully converted $video"
                ((converted++))
              else
                echo "✗ Failed to convert $video"
                cat /tmp/ffmpeg.log | tail -20
                ((failed++))
              fi
            else
              echo "⚠ Skipping $video (file not found)"
            fi
          done
          
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Conversion Summary:"
          echo "  Converted: $converted"
          echo "  Failed: $failed"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          if [ $failed -gt 0 ]; then
            exit 1
          fi
      
      - name: List converted files
        run: |
          echo "Converted files:"
          ls -lh public/videos/hevc/*.mov 2>/dev/null || echo "No MOV files found"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hevc-videos
          path: public/videos/hevc/*.mov
          retention-days: 30
          if-no-files-found: error
      
      - name: Commit and push HEVC videos
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are any changes
          git add public/videos/hevc/*.mov
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Add HEVC videos with alpha transparency

            Converted WebM videos to HEVC format for iOS Safari support.
            Generated by GitHub Actions workflow."
            git push
            echo "✓ Committed and pushed HEVC videos"
          fi
